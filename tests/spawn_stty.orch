--
-- Copyright (c) 2024 Kyle Evans <kevans@FreeBSD.org>
--
-- SPDX-License-Identifier: BSD-2-Clause
--

timeout(3)

spawn("cat")
-- Set -ICANON; this will timeout if canonicalization is on, since we haven't
-- sent an EOF.
stty("lflag", 0, tty.lflag.ICANON)

write "Hello the"
match "^Hello the$"

-- Also test cc changes
spawn("cat")

stty("cc", {
	VEOF = "^F"
})
write "Hello the^F"

match "^Hello the$"

-- Finally test for stty() use after the process has been released.
spawn("cat")

write "Hello\r"
match "^Hello"

-- Disable canonicalization and confirm that it took effect.  Note that if
-- cat(1) has re-entered read(2), which it almost certainly has, then we will
-- need to force another line through before raw mode will do anything useful.
stty("lflag", 0, tty.lflag.ICANON)
write "Dogs\r"
match "Dogs"

write "Partial"
match "Partial"
